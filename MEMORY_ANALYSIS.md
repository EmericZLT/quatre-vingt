# 内存占用分析

## 数据结构内存估算

### 1. Card 对象
每个 `Card` 对象包含：
- `suit`: Optional[Suit] (枚举，约 8 字节)
- `rank`: Rank (枚举，约 8 字节)  
- `is_joker`: bool (1 字节)
- Python 对象开销：约 56 字节

**单个 Card 对象：约 73 字节**

### 2. 游戏状态内存占用

#### 基础数据结构
- **4 名玩家手牌**：每人最多 25 张 = 100 张牌
  - 100 张 × 73 字节 = **7.3 KB**
  
- **底牌**：8 张
  - 8 × 73 字节 = **0.6 KB**

- **发牌区**：100 张（发牌阶段）
  - 100 × 73 字节 = **7.3 KB**

- **当前轮次出牌**：最多 4 名玩家，每人最多 25 张（甩牌）
  - 4 × 25 × 73 字节 = **7.3 KB**

- **上一轮出牌记录**：同上
  - **7.3 KB**

#### 游戏状态对象
- `GameState` 对象本身：约 **5-10 KB**
  - 各种列表、字典、集合
  - 字符串、整数等基础类型

- `CardPlayingSystem` 对象：约 **5-10 KB**
  - 包含所有子系统（TractorLogic, SlingshotLogic 等）
  - 手牌副本（用于甩牌验证）

#### 临时计算内存
- **拖拉机检测**：临时列表和字典
  - 最多处理 25 张牌的组合
  - 约 **2-5 KB**（处理完即释放）

- **甩牌验证**：临时数据结构
  - 分析牌型、比较大小
  - 约 **3-8 KB**（处理完即释放）

- **牌型比较**：临时排序和比较
  - 约 **1-3 KB**（处理完即释放）

### 3. Python 运行时内存

- **Python 解释器基础**：约 **30-50 MB**
- **FastAPI/Uvicorn**：约 **20-30 MB**
- **依赖库**：约 **10-20 MB**
- **WebSocket 连接**：每个连接约 **1-2 KB**

### 4. 总内存估算

#### 单局游戏峰值内存
```
基础运行时：        60-100 MB
游戏状态数据：      30-50 KB
临时计算：          5-15 KB（峰值，很快释放）
WebSocket 连接：    4 × 2 KB = 8 KB
─────────────────────────────────
总计：             约 60-100 MB
```

#### 多房间并发（假设 10 个房间）
```
基础运行时：        60-100 MB
10 个游戏状态：     300-500 KB
40 个 WebSocket：   80 KB
─────────────────────────────────
总计：             约 60-100 MB
```

## 结论

### ✅ 512MB 完全足够

**实际内存占用：60-100 MB**

**剩余空间：400-450 MB**

即使同时运行 **50-100 个房间**（200-400 名玩家），内存占用也远低于 512MB。

### 逻辑复杂度分析

#### 时间复杂度
- **拖拉机检测**：O(n log n) - n 最多为 25
- **甩牌验证**：O(n²) - n 最多为 25
- **牌型比较**：O(n) - n 最多为 25

**实际执行时间：< 10ms**

#### CPU 占用
- 单次出牌逻辑处理：< 1% CPU（0.1 CPU 足够）
- 并发 10 个房间：< 10% CPU

## 如果超过 512MB 会发生什么？

### Render Free Tier 限制

1. **内存溢出 (OOM)**
   - 进程会被系统杀死
   - 服务自动重启
   - 用户会看到连接错误

2. **性能下降**
   - 系统开始使用交换空间（swap）
   - 响应变慢
   - 可能出现超时

3. **服务中断**
   - Render 可能会暂停服务
   - 需要手动重启或升级

### 预防措施

1. **监控内存使用**
   - 在代码中添加内存监控
   - 使用 Render 的监控面板

2. **优化建议**（如果未来需要）
   - 清理已结束的游戏状态
   - 限制同时进行的房间数
   - 使用更轻量的数据结构

3. **升级方案**
   - Starter: $7/月，512MB RAM（无休眠）
   - Standard: $25/月，2GB RAM

## 实际测试建议

部署后可以通过以下方式监控：

```python
import psutil
import os

# 在健康检查端点添加
@app.get("/health")
async def health_check():
    process = psutil.Process(os.getpid())
    memory_mb = process.memory_info().rss / 1024 / 1024
    return {
        "status": "healthy",
        "memory_mb": round(memory_mb, 2),
        "cpu_percent": process.cpu_percent()
    }
```

## 总结

- ✅ **内存占用极低**：单局游戏 < 100KB
- ✅ **逻辑简单**：时间复杂度低，执行快速
- ✅ **512MB 足够**：可支持 50-100 个并发房间
- ✅ **Free Tier 可行**：完全满足当前需求

**建议**：先用 Free Tier 测试，如果未来需要更多功能（无休眠、更多内存），再考虑升级。

